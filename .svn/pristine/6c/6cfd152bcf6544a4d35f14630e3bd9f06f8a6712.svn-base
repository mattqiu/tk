<?php

/**
 * User: Able
 * Date: 2017/5/8
 * Time: 15:55
 */
class o_logistics_interface extends MY_Model
{

    function __construct() {
        parent::__construct();
    }


    /**
     * 筛选快递
     * @param $keyword
     * @param $orderNo
     */
    function searchExpress($keyword,$orderNo){
        $returnData = "";
        switch ($keyword){
            case 101: //韵达快递
                $url = "http://dev.yundasys.com:15105/join/query/json.php?partnerid=yunda&mailno=$orderNo&charset=utf8"; //测试URL
                $result = $this->curlRequest($url,"get");
                $res = json_decode($result,true);
                if($res['result']){
                    $returnData = $res['steps'];
                }
                break;
            case 102: //顺丰速运
                $appId = "00027274";
                $appKey = "8EFC34568527805D0D12AF26ACA9CDFC";
                $url="https://open-sbox.sf-express.com/public/v1.0/security/access_token/sf_appid/$appId/sf_appkey/$appKey";  //申请token
                $data='{"head":{"transType":"301","transMessageId":"'.date("Ymd").$this->randNumber().'"}}';
                $result = $this->doCurl($url,$data);
                $data = json_decode($result,true);
                if(empty($data['body'])){
                    return "";
                }
                $url = "https://open-sbox.sf-express.com/rest/v1.0/route/query/access_token/".$data['body']['accessToken']."/sf_appid/$appId/sf_appkey/$appKey";
                $data = '{"head":{"transType":"501","transMessageId":"'.date("Ymd").$this->randNumber().'"},"body":{"trackingType":"1","trackingNumber":"'.$orderNo.'","methodType":"1"}}';
                $result = $this->doCurl($url,$data);
                $returnData = json_decode($result,true);
                break;
            case 103: //中通快递
                $url="http://japi.zto.cn/gateway.do";
                $msg_type = "TRACEINTERFACE_NEW_TRACES";
                $keys = "cdd035f8d87b";
                $company_id = "9d42aebf573c4d7fb56576c93d339eea";
                $data_digest = base64_encode(md5("['$orderNo']".$keys, TRUE));
                $post_data = array(
                    "data"=>"['$orderNo']",
                    "data_digest" =>$data_digest,
                    "company_id"=>$company_id,
                    "msg_type"=>$msg_type
                );
                $result = $this->curlRequest($url,"post",$post_data);
                $data = json_decode($result,true);
                if(!empty($data['data'])){
                    $returnData = $data['data'][0]['traces'];
                }
                break;
            case 104: //天天快递

                break;
            case 105: //申通快递

                break;
            case 106: //圆通速递

                break;
            case 107: //全峰快递

                break;
            case 110: //宅急送快递

                break;
            case 111: //优速快递
                $partner = "80238798";
                $charset = "GBK";
                $dataType = "json";
                $serviceName = "query_trace";
                $key = "cbbc2b0bd37466688e9eeed59c570ce6";
                $url = "http://119.147.84.81/com.uc56.uop.main/gateway/gateway.action";
                $data = '{"bill":{"billCode":"'.$orderNo.'","orderCode":"","queryType":"0"}}';
                $str = "charset=".$charset."&data=".$data."&dataType=".$dataType."&partner=".$partner."&serviceName=".$serviceName.$key;
                $dataSign = md5($str);
                $post_data = array(
                    "partner"=>$partner,
                    "charset"=>$charset,
                    "dataType"=>$dataType,
                    "serviceName"=>$serviceName,
                    "data"=>$data,
                    "dataSign"=>$dataSign
                );
                $result = $this->curlRequest($url,"post",$post_data);
                $data = (json_decode(iconv("GBK", "UTF-8", $result),true));
                if($data['response']['isSuccess'] == "T" && isset($data['response']['traceList'])){
                    $returnData = $data['response']['traceList'][0]['trace'];
                }
                break;
            case 112: //德邦

                break;
            case 113: //百世汇通

                break;
            case 114: //安能物流

                break;
            case 117: //邮政快递

                break;
            case 118: //国通快递

                break;
            case 120: //快捷快递

                break;
            case 130: //百世快递

                break;
        }
        if(!empty($returnData)){
            return $returnData;
        }else{
            //快递100接口
        }

    }


    /**
     * CURL 请求方法
     * @param $url
     * @param $post_data
     * @param $requestType post get
     * @return mixed
     */
    private function curlRequest($url,$requestType,$post_data=""){
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        //curl_setopt($ch, CURLOPT_HEADER,1);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        if($requestType == "post"){
            curl_setopt($ch, CURLOPT_POST, 1);
            if(!empty($post_data)){
                curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
            }
        }
        curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, 5);
        $output = curl_exec($ch);
        curl_close($ch);
        return $output;
    }


    /**
     * 报文请求
     * @param $url
     * @param $data
     * @return mixed
     */
    function doCurl($url,$data){
        $ch=curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
        //curl_setopt($ch, CURLOPT_HEADER,1);
        curl_setopt($ch, CURLOPT_TIMEOUT,5);
        curl_setopt($ch,CURLOPT_POST, true);
        $header = $this->FormatHeader($url,$data);
        curl_setopt($ch, CURLOPT_HTTPHEADER,$header);
        curl_setopt($ch, CURLOPT_POSTFIELDS,$data);
        $rs=curl_exec($ch);
        curl_close($ch);
        return $rs;
    }

    function FormatHeader($url,$data){
        $temp = parse_url($url);
        $query = isset($temp['query']) ? $temp['query'] : '';
        $path = isset($temp['path']) ? $temp['path'] : '/';
        $header = array (
            "POST {$path}?{$query} HTTP/1.1",
            "Host: {$temp['host']}",
            "Content-Type: application/json",
            "Content-length: ".strlen($data),
            "Connection: Close"
        );
        return $header;
    }


    private function randNumber(){
        $a = range(0,9);
        for($i=0;$i<10;$i++){
            $b[] = array_rand($a);
        }
        return join("",$b);
    }

}